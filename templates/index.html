{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">
                    <i class="fas fa-download"></i> Download Manga
                </h3>
            </div>
            <div class="card-body">
                <form id="downloadForm">
                    <div class="mb-3">
                        <label for="url" class="form-label">MangaDx URL</label>
                        <input type="url" class="form-control" id="url" name="url" required 
                               placeholder="https://mangadx.org/title/..." />
                        <div class="form-text">
                            Enter a MangaDx URL (manga, chapter, or list)
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="format" class="form-label">Output Format</label>
                                <select class="form-select" id="format" name="format">
                                    <optgroup label="Raw Images">
                                        <option value="raw">Raw - Separate chapter folders</option>
                                        <option value="raw-volume">Raw Volume - Grouped by volume</option>
                                        <option value="raw-single">Raw Single - All in one folder</option>
                                    </optgroup>
                                    <optgroup label="PDF">
                                        <option value="pdf">PDF - Separate chapter files</option>
                                        <option value="pdf-volume">PDF Volume - Grouped by volume</option>
                                        <option value="pdf-single">PDF Single - All in one file</option>
                                    </optgroup>
                                    <optgroup label="Comic Book Archive (CBZ)">
                                        <option value="cbz">CBZ - Separate chapter files</option>
                                        <option value="cbz-volume">CBZ Volume - Grouped by volume</option>
                                        <option value="cbz-single">CBZ Single - All in one file</option>
                                    </optgroup>
                                    <optgroup label="Comic Book Archive (CB7)">
                                        <option value="cb7">CB7 - Separate chapter files</option>
                                        <option value="cb7-volume">CB7 Volume - Grouped by volume</option>
                                        <option value="cb7-single">CB7 Single - All in one file</option>
                                    </optgroup>
                                    <optgroup label="EPUB">
                                        <option value="epub">EPUB - Separate chapter files</option>
                                        <option value="epub-volume">EPUB Volume - Grouped by volume</option>
                                        <option value="epub-single">EPUB Single - All in one file</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="language" class="form-label">Language</label>
                                <select class="form-select" id="language" name="language">
                                    <option value="en">English</option>
                                    <option value="ja">Japanese</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="it">Italian</option>
                                    <option value="pt">Portuguese</option>
                                    <option value="ko">Korean</option>
                                    <option value="zh">Chinese</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="start_chapter" class="form-label">Start Chapter (Optional)</label>
                                <input type="number" class="form-control" id="start_chapter" name="start_chapter" 
                                       min="1" step="0.1" placeholder="e.g., 1 or 1.5" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="end_chapter" class="form-label">End Chapter (Optional)</label>
                                <input type="number" class="form-control" id="end_chapter" name="end_chapter" 
                                       min="1" step="0.1" placeholder="e.g., 10 or 10.5" />
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="no_oneshot" name="no_oneshot">
                            <label class="form-check-label" for="no_oneshot">
                                Skip oneshot chapters
                            </label>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-download"></i> Start Download
                        </button>
                    </div>
                </form>

                <!-- Progress Section -->
                <div id="progressSection" class="mt-4" style="display: none;">
                    <h5>Download Progress</h5>
                    <div class="progress mb-3">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="downloadStatus" class="text-muted"></div>
                    <div id="downloadOutput" class="mt-3" style="display: none;">
                        <h6>Download Log:</h6>
                        <div class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                            <pre id="outputContent"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Downloads -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history"></i> Recent Downloads
                </h5>
            </div>
            <div class="card-body">
                <div id="recentDownloads">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('downloadForm');
    const progressSection = document.getElementById('progressSection');
    const progressBar = document.getElementById('progressBar');
    const downloadStatus = document.getElementById('downloadStatus');
    const downloadOutput = document.getElementById('downloadOutput');
    const outputContent = document.getElementById('outputContent');
    
    let currentDownloadId = null;
    let statusInterval = null;

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        // Convert checkbox to boolean
        data.no_oneshot = formData.has('no_oneshot');
        
        fetch('/download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                currentDownloadId = result.download_id;
                showProgress();
                startStatusPolling();
            } else {
                alert('Error: ' + result.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while starting the download');
        });
    });

    function showProgress() {
        progressSection.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        downloadStatus.textContent = 'Starting download...';
        outputContent.textContent = '';
        downloadOutput.style.display = 'none';
    }

    function startStatusPolling() {
        if (statusInterval) {
            clearInterval(statusInterval);
        }
        
        statusInterval = setInterval(() => {
            if (currentDownloadId) {
                fetch(`/status/${currentDownloadId}`)
                .then(response => response.json())
                .then(status => {
                    updateProgress(status);
                    
                    if (status.status === 'completed' || status.status === 'failed') {
                        clearInterval(statusInterval);
                        loadRecentDownloads();
                    }
                })
                .catch(error => {
                    console.error('Error polling status:', error);
                });
            }
        }, 1000);
    }

    function updateProgress(status) {
        const progress = Math.round(status.progress || 0);
        progressBar.style.width = progress + '%';
        progressBar.textContent = progress + '%';
        
        let statusText = '';
        switch (status.status) {
            case 'starting':
                statusText = 'Initializing download...';
                break;
            case 'downloading':
                statusText = `Downloading... (${progress}%)`;
                break;
            case 'completed':
                statusText = 'Download completed successfully!';
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');
                break;
            case 'failed':
                statusText = 'Download failed: ' + (status.error || 'Unknown error');
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
                break;
        }
        
        downloadStatus.textContent = statusText;
        
        if (status.output && status.output.length > 0) {
            downloadOutput.style.display = 'block';
            outputContent.textContent = status.output.join('\n');
            outputContent.parentElement.scrollTop = outputContent.parentElement.scrollHeight;
        }
    }

    function loadRecentDownloads() {
        fetch('/api/downloads')
        .then(response => response.json())
        .then(downloads => {
            const container = document.getElementById('recentDownloads');
            
            if (downloads.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No downloads yet</div>';
                return;
            }
            
            const recentDownloads = downloads.slice(0, 5);
            container.innerHTML = recentDownloads.map(download => `
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <div class="flex-grow-1">
                        <div class="fw-bold text-truncate" style="max-width: 400px;" title="${download.url}">
                            ${new URL(download.url).pathname.split('/').pop() || 'Download'}
                        </div>
                        <small class="text-muted">${new Date(download.started_at).toLocaleString()}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-${getStatusColor(download.status)}">${download.status}</span>
                        ${download.progress ? `<div class="small text-muted">${Math.round(download.progress)}%</div>` : ''}
                    </div>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Error loading recent downloads:', error);
            document.getElementById('recentDownloads').innerHTML = 
                '<div class="text-center text-danger">Error loading downloads</div>';
        });
    }

    function getStatusColor(status) {
        switch (status) {
            case 'completed': return 'success';
            case 'failed': return 'danger';
            case 'downloading': return 'primary';
            default: return 'secondary';
        }
    }

    // Load recent downloads on page load
    loadRecentDownloads();
});
</script>
{% endblock %}
